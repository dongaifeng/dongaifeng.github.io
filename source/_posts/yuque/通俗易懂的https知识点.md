## 背景
## 前提知识
### 了解tcp，http
> HTTP协议是Hyper Text Transfer Protocol（超文本传输协议），基于TCP/IP通信协议来传递数据。
> TCP/IP 协议按层次分别分为以下4层，（也有说五层，物理层）。OSI是7层。

应用层：负责处理特定的应用程序细节。DNS解析域名，FTP下载文件，HTTP超文本传输。
传输层：主要为两台主机上的应用建立连接，TCP协议
安全层：CA认证，加密数据，SSL就是应用层跟传输层之间的一层协议，主要是对数据加密
![截屏2021-11-10 19.51.19.png](https://cdn.nlark.com/yuque/0/2021/png/462392/1636616689648-02cbd2c0-5f16-4e07-a532-5b3f833e43b0.png#clientId=ua51f9617-d999-4&crop=0&crop=0&crop=1&crop=1&from=ui&height=266&id=u132837c1&margin=%5Bobject%20Object%5D&name=%E6%88%AA%E5%B1%8F2021-11-10%2019.51.19.png&originHeight=563&originWidth=1346&originalType=binary&ratio=1&rotation=0&showTitle=false&size=134964&status=done&style=none&taskId=u97fd03fa-ccfe-44ac-a248-32705603546&title=&width=635)
**三次握手**
第一次握手：
客户端发送SYN包(seq=x)到服务器，并进入SYN_SEND状态，等待服务器确认。
第二次握手：
服务器收到SYN包，必须确认客户的SYN(ack=x+1)，同时自己也发送一个SYN包(seq=y)，即SYN+ACK包，此时服务器进入SYN_RECV状态。
第三次握手：
客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack=y+1)，此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手。

![ca6dbfa7901458f8abb62e9704d295df.png](https://cdn.nlark.com/yuque/0/2021/png/462392/1636615509129-a301ca07-b613-4012-be33-749b19041553.png#clientId=uecb0f350-2197-4&crop=0&crop=0&crop=1&crop=1&from=ui&height=431&id=u1aa77288&margin=%5Bobject%20Object%5D&name=ca6dbfa7901458f8abb62e9704d295df.png&originHeight=610&originWidth=734&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33314&status=done&style=none&taskId=u8a1829cc-328e-4695-bc42-39382d5af9a&title=&width=519)
**四次挥手**
第一次挥手：
主动关闭方发送一个FIN，用来关闭主动方到被动关闭方的数据传送，也就是主动关闭方告诉被动关闭方：我已经不会再给你发数据了(当 然，在fin包之前发送出去的数据，如果没有收到对应的ack确认报文，主动关闭方依然会重发这些数据)，但此时主动关闭方还可以接受数据。
第二次挥手：
被动关闭方收到FIN包后，发送一个ACK给对方，确认序号为收到序号+1(与SYN相同，一个FIN占用一个序号)。
第三次挥手：
被动关闭方发送一个FIN，用来关闭被动关闭方到主动关闭方的数据传送，也就是告诉主动关闭方，我的数据也发送完了，不会再给你发数据了。
第四次挥手：
主动关闭方收到FIN后，发送一个ACK给被动关闭方，确认序号为收到序号+1，至此，完成四次挥手。
![851c5465701a9220100681120c61609e.png](https://cdn.nlark.com/yuque/0/2021/png/462392/1636615568710-3c8bfe18-29c5-4c43-9c71-648ed861dc00.png#clientId=uecb0f350-2197-4&crop=0&crop=0&crop=1&crop=1&from=ui&height=477&id=uc50a7efd&margin=%5Bobject%20Object%5D&name=851c5465701a9220100681120c61609e.png&originHeight=638&originWidth=665&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37532&status=done&style=none&taskId=u24bcf015-a1a6-40a1-9047-7f7c980bf1b&title=&width=497)
四层协议
抓包工具

### 加密算法
#### 对称加密
> 采用单钥密码系统的加密方法，同一个密钥用来加密和解密。

常见的对称加密：DES，AES，3DES，RC
前端解决方案：[crypto.js](https://github.com/brix/crypto-js)
#### 非对称加密
> 非对称加密需要两个密钥：公钥 (publickey) 和私钥 (privatekey)。公钥和私钥是一对，用公钥对数据加密，只能用对应的私钥解密。如果用私钥对数据加密，只能用对应的公钥进行解密。

常见的非对称加密：DH, DSA, RSA, ECC
前端非对称加密方案：[jsencrypt](https://github.com/travist/jsencrypt)
**摘要算法**
> 摘要算法又称哈希算法，它表示输入任意长度的数据，输出固定长度的数据，相同的输入数据始终得到相同的输出，不同的输入数据尽量得到不同的输出（碰撞问题）

消息摘要采用单向Hash函数将需加密的明文"摘要"成一串固定位数的密文，具有不可逆性。又叫指纹，签名。
常见的摘要算法：MD5，SHA1，SHA2
## 理解概念
#### CA机构，证书
数字证书颁发机构，负责管理和签发CA证书的第三方机构。
CA证书，也叫SSL证书，就是CA机构颁发的证书。SSL使用X.509格式，X.509是一种数字证书格式的标准。证书中包含的信息：

- 服务器的公钥
- 签名算法
- 签名
- 证书有效日期
- CA机构的名称

CA证书的分类：

- DV证书，只验证申请者的域名所有权
- OV证书，需要验证申请者的身份，域名所有权
- EV证书，严格的验证申请者的身份，域名所有权，商业信息
#### 签名
CA机构用哈希算法对 服务器公钥 生成 摘要1（哈希值）。加密后得到签名，也叫指纹。这里的加密是非对称加密（CA机构的私钥）。
浏览器用 哈希算法 对 服务器公钥 生成 摘要2（哈希值），然后解密上面得到的指纹，然后对比摘要1 和 摘要2 ，来验证证书的合法性，这里的解密用的是上面用到的非对称加密（CA机构的公钥）。
**整体流程**
![](https://cdn.nlark.com/yuque/0/2021/jpeg/462392/1636960604328-958899fc-7464-4928-8c9c-ec56382af200.jpeg)
**第一步：**
服务方申请人向第三方机构CA提交公钥、组织信息、个人信息(域名)等信息并申请认证；
**第二步：**
CA机构通过线上、线下等多种手段验证申请者提供信息的真实性，比如组织是否存在、企业是否合法，是否拥有域名的所有权等；
**第三步：**
如信息审核通过，CA机构会向申请人签发CA证书。证书包含以下信息：申请者公钥、申请者的组织信息和个人信息、签发机构 CA 的信息、有效时间、证书序列号等信息的明文，同时包含一个签名；
制作签名的过程：

   1. 首先，使用哈希算法对服务器的公钥计算，生产哈希值（摘要）。
   1. 然后，采用非对称加密 + CA 的私钥对哈希值（摘要）进行加密，密文即签名。

**第四步：**
浏览器向服务器发出请求时，服务器返回证书文件；
**第五步：**
浏览器读取证书中的相关的明文信息，然后开始验证证书。过程如下：

   1. 采用相同的哈希算法对服务器的公钥计算，生产哈希值（摘要）。
   1. 然后使用对应CA机构 的公钥（公钥保存在电脑本地）解密证书中的签名，得到证书中的哈希值（摘要）。
   1. 对比a步骤产生的摘要，b步骤产生的摘要，相同即证书合法；

需要注意的点：

- 申请CA证书需要提供公钥，并且私钥保存在服务器不得外传。
- CA机构也是采用非对称加密，保证证书合法。
- 电脑系统本地都会保存一份CA机构的根证书，里面有CA机构的公钥。
#### CSR
CSR是由申请人为获得SSL证书提交给CA的申请，是一段编码信息。包含一个公钥以及申请人信息。

可以使用OpenSSL工具创建CSR。
运行以下命令:
```shell
openssl req -new -nodes -keyout private.key -out server.csr 
```
将得到两个输出文件:

- **private.key**: 这是你的私钥。你应该将其存储在服务器的安全位置，安装证书时需要用到。
- **server.csr**: 证书签发申请(CSR)，将被提交给CA
#### SSL/TLS
SSL（Secure Sockets Layer），安全套接字层，是一种在应用层和传输层之间加密数据的一种加密协议。
TLS（Transport Layer Security），传输层安全性协议。TLS是SSL协议的升级版。
TLS/SSL协议中使用了非对称加密，对称加密以及HASH算法。
#### 公钥，密钥
## 四次握手过程
HTTPS的整体过程分为证书验证和数据传输阶段，证书验证阶段也可叫做四次握手。
常用的对称加密方法，非对称加密方法。
### 证书验证阶段
第一步：
浏览器向服务器发送请求比如：https://www.baidu.com。发送的内容包括：

- 浏览器支持的SSL协议版本号。
- 浏览器支持的加密算法
- 一个随机数
- 会话的相关数据

第二步：
https的默认端口是443，所以当443端口接受到请求后，会向浏览器发送内容：

- SSL版本号，确认与浏览器使用同一版本的协议。
- 加密算法，确认与浏览器使用同一种加密方法。
- 一个随机数，用于生产“会话密钥”
- SSL证书，CA机构颁发的证书，里面包换公钥，网站管理者的一些信息。

第三步：
浏览器收到证书后，判断证书是否合法。
第四步：
如果合法，浏览器会从中取出公钥，并生成第三个随机数。然后再用证书里面的公匙加密随机数发送给服务器。发送的内容有：

- 加密后的随机数，这个随机数会和前面两个随机数通过事先商定的加密方法加工成“会话密钥”。
- 编码改变通知，表示随后的信息将使用对称加密传输。
- 结束握手通知。

第五步：
服务器接收到密文后，用私匙解密，得到第三个随机数，然后也会通过事先商定的加密方法计算出“会话密钥”。后面的数据传输阶段就用对称加密算法加上“会话密钥”传输数据。然后返回数据：

- 编码改变通知，表示随后的信息将使用对称加密传输。
- 结束握手通知。

到这里证书验证阶段结束，后面的数据传输就会使用对称加密传输。
![](https://cdn.nlark.com/yuque/0/2021/jpeg/462392/1636961029652-11ec8dc0-9a77-4c92-9a03-7e5377064922.jpeg)

ssl四次握手之前需要tcp的三次握手。
tcp的三次握手前两次是不能携带数据的。
SLL协议是建立在TCP协议之上的。
## 升级网站为https
[https://github.com/wsdo/local-https-cert](https://github.com/wsdo/local-https-cert)
[阿里云](https://www.aliyun.com/product/cas)
## https弊端，优化





















