---
title: 网站部署笔记
urlname: aitlt9
date: '2020-01-31 14:29:58 +0800'
tags: []
categories: []
---

## 环境搭建

### mysql

mysql 安装两种方法

- YUM 安装
- 压缩包方法

#### YUM 安装

从 CentOS 7 开始，MariaDB 成为 Yum 源中默认的数据库安装包。也就是说在 CentOS 7 及以上的系统中使用 yum 安装 MySQL 默认安装的会是 MariaDB（MySQL 的一个分支）。如果想安装官方 MySQL 版本，需要使用 MySQL 提供的 Yum 源。
所有需要先下载 yum repo 配置文件。
这里直接下载的是 mysql5.7 版本的 rpm，也可以选其他的。

```
wget https://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm
```

然后进行 repo 安装。

```
rpm -ivh mysql57-community-release-el7-9.noarch.rpm
```

然后才能安装 mysql

```
yum install mysql-server
```

详细操作可以参考一下链接
[https://blog.csdn.net/wohiusdashi/article/details/89358071](https://blog.csdn.net/wohiusdashi/article/details/89358071)
[https://segmentfault.com/a/1190000019507071](https://segmentfault.com/a/1190000019507071)

#### 压缩包安装

从官网下载压缩包，上传到 centOS 上
官网 5.7 版本：[https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.29-1.el7.x86_64.rpm-bundle.tar](https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.29-1.el7.x86_64.rpm-bundle.tar)
然后解压。
然后安装。
参考链接。
[https://www.cnblogs.com/raicho/p/12511998.html](https://www.cnblogs.com/raicho/p/12511998.html#%E5%AE%89%E8%A3%85%E5%8C%85%E4%B8%8B%E8%BD%BD%E5%B9%B6%E4%B8%8A%E4%BC%A0%E5%https://www.cnblogs.com/raicho/p/12511998.html)
[https://www.cnblogs.com/bsw-zhen/p/11022565.html](https://www.cnblogs.com/bsw-zhen/p/11022565.html)

设置 root 远程登录出错：
![image.png](https://cdn.nlark.com/yuque/0/2021/png/462392/1612419357373-7a10dc5c-55a6-4961-bca9-47a7d3d41a8c.png#align=left&display=inline&height=218&margin=%5Bobject%20Object%5D&name=image.png&originHeight=218&originWidth=1162&size=32169&status=done&style=none&width=1162)
参考：[https://www.cnblogs.com/fan-yuan/p/9979252.html](https://www.cnblogs.com/fan-yuan/p/9979252.html)
也可参考下面链接的解决办法：
[http://blog.itpub.net/69948194/viewspace-2668406/](http://blog.itpub.net/69948194/viewspace-2668406/)

### nginx

#### 通过 Yum 安装 Nginx

这种方式是非常简单方便，nginx 官网上也有介绍[http://nginx.org/en/linux_packages.html#RHEL-CentOS](http://nginx.org/en/linux_packages.html#RHEL-CentOS)
官方说明就是在/etc/yum.repo.d 目录下面创建一个 nginx 的 yum 源，然后就可以直接用 yum install nginx 安装了，超级简单，这种方式就直接帮你把服务、都安装好了。
默认情况 Centos7 中无 Nginx 的源，最近发现 Nginx 官网提供了 Centos 的源地址。

```
rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm
```

[https://zhuanlan.zhihu.com/p/136824395](https://zhuanlan.zhihu.com/p/136824395)

#### 压缩包安装

如果没有 nginx 源，需要自己下载压缩包安装。
参考链接：[https://www.cnblogs.com/boonya/p/7907999.html](https://www.cnblogs.com/boonya/p/7907999.html)

### node 环境安装

node 环境安装参考：[https://www.cnblogs.com/tengqf/articles/14220444.html](https://www.cnblogs.com/tengqf/articles/14220444.html)

#### pm2

```
npm install -g pm2
```

### git

### docker

## 前后端分开部署

#### 前端  react 项目

- 设置接口地址： let base = "http://47.105.185.203:7001";
- 删除 package.json  的  proxy， homepage  设置。
- 代码打包好以后放到   阿里云上的 nginx 里面的 html 里。
- nginx.conf 里面加入以下配置反向代理（如果后端设置 cors 也可不用）。

```nginx
server {
        listen       7001;
        server_name  47.105.185.203;

        #charset koi8-r;
        #access_log  logs/host.access.log  main;

        location / {
            root   html;
            #访问nginx的7001 转发到 http://47.105.185.203:7001
            proxy_pass  http://47.105.185.203:7001;
            index  index.html index.htm;
        }
    }
```

#### 后端

- egg-cors 设置跨域

[egg-cors 教程](https://blog.csdn.net/bocongbo/article/details/83656506)

##### 另一种方式

1 前端不设置 baseUrl，还是请求 本端口。然后用 nginx 代理到后台端口 7000.

```javascript
 server {
        listen       80;
        server_name  8.141.49.190;
        root        /home/tucao/frontend;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location /api {
	        # root   frontend;
	        proxy_pass  http://8.141.49.190:7000;
	        # index  index.html index.htm;
        }

         location /public {
            # root   frontend;
            proxy_pass  http://8.141.49.190:7000;
            # index  index.html index.htm;
        }

        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
    }
```

## 前端代码放到后端项目  

#### 前端

在 package.json 里设置  "homepage": "/public",
设置接口地址   *let base = ''*

#### 后端

打包后的 index.html  放到 views 文件夹下。
其他的文件放到 public 文件夹下。
在 config.default.js 设置模板解析

```javascript
config.view = {
  defaultViewEngine: "nunjucks",
  mapping: {
    ".html": "nunjucks",
  },
};
```

[egg-view-nunjucks 教程](https://eggjs.org/zh-cn/core/view.html)

#### 另一种方式

把前端代码放到 view 里面
设置 congfig.static
config.static = { 
    prefix: '/public/', //  设置静态文件   请求时的前缀
    dir: [path.join(appInfo.baseDir, 'app/public'), path.join(appInfo.baseDir, 'app/view')]//  多静态文件入口
  };
修改 index.html 中引入 js，css 的路径： /public/umi.css

## docker 部署+webhook

### 在 gitee 新建仓库

建一个项目仓库，并在仓库 setting 设置 wehooks
![image.png](https://cdn.nlark.com/yuque/0/2020/png/462392/1580616088694-1ee0eeb7-28c9-49c0-abf8-1dfe67877a82.png#align=left&display=inline&height=176&margin=%5Bobject%20Object%5D&name=image.png&originHeight=352&originWidth=825&size=32997&status=done&style=none&width=412.5)

### 在阿里云服务器写个 webhooks 服务

在阿里云上写个 http 服务，用于监听 gitee 事件。

- 使用 gitee-webhook-handler 包来监听事件。
- 设置的接口以及签名要与 gitee 上的 webhooks 一致
- 这里有个坑，每次修改 webhook.js 。都要重新在 gitee 新建 webhook

```javascript
// webhook.js
var http = require("http");
var createHandler = require("gitee-webhook-handler");
var handler = createHandler({ path: "/webhook", secret: "***" }); // secret 保持和 GitHub 后台设置的一致

function run_cmd(cmd, args, callback) {
  var spawn = require("child_process").spawn;
  var child = spawn(cmd, args);
  var resp = "";

  child.stdout.on("data", function (buffer) {
    resp += buffer.toString();
  });
  child.stdout.on("end", function () {
    callback(resp);
  });
}

http
  .createServer(function (req, res) {
    handler(req, res, function (err) {
      res.statusCode = 404;
      res.end("no such location");
    });
  })
  .listen(7777, () => {
    console.log("WebHooks Listern at 7777");
  });

handler.on("error", function (err) {
  console.error("Error:", err.message);
});

// handler.on('*', function (event) {
//     console.log('Received *', event.payload.action);
//     //   run_cmd('sh', ['./deploy-dev.sh'], function(text){ console.log(text) });
// })

handler.on("Push Hook", function (event) {
  console.log(
    "Received a push event for %s to %s",
    event.payload.repository.name,
    event.payload.ref
  );
  // 分支判断
  if (event.payload.ref === "refs/heads/master") {
    console.log("deploy master..");
    run_cmd("sh", ["./deploy-dev.sh"], function (text) {
      console.log(text);
    });
  }
});

// handler.on('issues', function (event) {
//     console.log('Received an issue event for % action=%s: #%d %s',
//         event.payload.repository.name,
//         event.payload.action,
//         event.payload.issue.number,
//         event.payload.issue.title)
// })
```

### deploy 脚本

当 push 事件触发 执行 deploy.sh 脚本

```javascript
echo Deploy Project
# docker-compose up -d --force-recreate --build

# 获取最新版代码
git pull

# 强制重新编译容器
docker-compose down
docker-compose up -d --force-recreate --build

# 定制镜像
# docker build -t myapp:pm2 ./backend

# 重启启动容器
# docker stop myapp
# docker rm myapp
# docker run --name myapp -p 3000:3000  -d myapp:pm2
```

### 在 centOS 配置 git 以及 remote，密匙
